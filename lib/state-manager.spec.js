"use strict";

var _stateManager = require("./state-manager");

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

describe("StateManager", function () {
  describe("localStorage unavailable", function () {
    it("not throw any error on constructor", function () {
      expect(new _stateManager.StateManager()).toThrowErrorMatchingSnapshot();
    });
    describe("messages", function () {
      var stateManager;
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
      });
      it("adds new message when message is saved", function () {
        var message = {
          sender: "human",
          label: "test message",
          type: "plain"
        };
        stateManager.saveMessages([message]);
        expect(stateManager.messages[0]).toMatchObject(message);
      });
      it("removes message when it pops", function () {
        stateManager.popMessage();
        expect(stateManager.messages[0]).toBeUndefined();
      });
    });
    describe("layout", function () {
      var stateManager;
      var initialLayout = {
        isMessengerOpen: false
      };
      var overrideLayout = {
        someValue: true
      };
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
        stateManager.updateLayout(initialLayout);
      });
      it("adds layout properties", function () {
        stateManager.updateLayout(overrideLayout);
        expect(stateManager.layout).toEqual(_objectSpread({}, initialLayout, overrideLayout));
      });
      it("overrides a property", function () {
        stateManager.updateLayout({
          isMessengerOpen: true
        });
        expect(stateManager.layout.isMessengerOpen).toBeTruthy();
      });
    });
  });
  describe("localstorage available", function () {
    beforeEach(function () {
      require("jest-localstorage-mock");

      localStorage.clear();
    });
    describe("with clean localStorage", function () {
      it("initializes empty messages storage", function () {
        expect(new _stateManager.StateManager().messages).toHaveLength(0);
      });
    });
    describe("constructor when existing localStorage", function () {
      var initialMessages;
      var initialLayout;
      var initialAgent;
      var stateManager;
      beforeEach(function () {
        initialMessages = [{
          type: "plain",
          sender: "bot",
          label: "Test message from bot"
        }];
        initialLayout = {
          isMessengerOpen: true
        };
        initialAgent = {
          isInitialized: true
        };
        localStorage.setItem(_stateManager.StateManager.keys.messages, JSON.stringify(initialMessages));
        localStorage.setItem(_stateManager.StateManager.keys.layout, JSON.stringify(initialLayout));
        localStorage.setItem(_stateManager.StateManager.keys.agent, JSON.stringify(initialAgent));
        stateManager = new _stateManager.StateManager();
      });
      it("initializes messages from localStorage", function () {
        expect(stateManager.messages).toEqual(initialMessages);
      });
      it("initializes layout from localStorage", function () {
        expect(stateManager.layout).toEqual(initialLayout);
      });
      it("initializes agent from localStorage", function () {
        expect(stateManager.agent).toEqual(initialAgent);
      });
    });
    describe("messages", function () {
      var stateManager;
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
      });
      it("adds new message when message is saved", function () {
        var message = {
          sender: "human",
          label: "test message",
          type: "plain"
        };
        stateManager.saveMessages([message]);
        expect(stateManager.messages[0]).toMatchObject(message);
      });
      it("removes message when it pops", function () {
        stateManager.popMessage();
        expect(stateManager.messages[0]).toBeUndefined();
      });
    });
    describe("layout", function () {
      var stateManager;
      var initialLayout = {
        isMessengerOpen: false
      };
      var overrideLayout = {
        someValue: true
      };
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
        stateManager.updateLayout(initialLayout);
      });
      it("adds layout properties", function () {
        stateManager.updateLayout(overrideLayout);
        expect(stateManager.layout).toEqual(_objectSpread({}, initialLayout, overrideLayout));
      });
      it("overrides a property", function () {
        stateManager.updateLayout({
          isMessengerOpen: true
        });
        expect(stateManager.layout.isMessengerOpen).toBeTruthy();
      });
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdGF0ZS1tYW5hZ2VyLnNwZWMudHMiXSwibmFtZXMiOlsiZGVzY3JpYmUiLCJpdCIsImV4cGVjdCIsIlN0YXRlTWFuYWdlciIsInRvVGhyb3dFcnJvck1hdGNoaW5nU25hcHNob3QiLCJzdGF0ZU1hbmFnZXIiLCJiZWZvcmVFYWNoIiwibWVzc2FnZSIsInNlbmRlciIsImxhYmVsIiwidHlwZSIsInNhdmVNZXNzYWdlcyIsIm1lc3NhZ2VzIiwidG9NYXRjaE9iamVjdCIsInBvcE1lc3NhZ2UiLCJ0b0JlVW5kZWZpbmVkIiwiaW5pdGlhbExheW91dCIsImlzTWVzc2VuZ2VyT3BlbiIsIm92ZXJyaWRlTGF5b3V0Iiwic29tZVZhbHVlIiwidXBkYXRlTGF5b3V0IiwibGF5b3V0IiwidG9FcXVhbCIsInRvQmVUcnV0aHkiLCJyZXF1aXJlIiwibG9jYWxTdG9yYWdlIiwiY2xlYXIiLCJ0b0hhdmVMZW5ndGgiLCJpbml0aWFsTWVzc2FnZXMiLCJpbml0aWFsQWdlbnQiLCJpc0luaXRpYWxpemVkIiwic2V0SXRlbSIsImtleXMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWdlbnQiXSwibWFwcGluZ3MiOiI7O0FBQ0E7Ozs7OztBQUVBQSxRQUFRLENBQUMsY0FBRCxFQUFpQixZQUFNO0FBQzdCQSxFQUFBQSxRQUFRLENBQUMsMEJBQUQsRUFBNkIsWUFBTTtBQUN6Q0MsSUFBQUEsRUFBRSxDQUFDLG9DQUFELEVBQXVDLFlBQU07QUFDN0NDLE1BQUFBLE1BQU0sQ0FBQyxJQUFJQywwQkFBSixFQUFELENBQU4sQ0FBMkJDLDRCQUEzQjtBQUNELEtBRkMsQ0FBRjtBQUlBSixJQUFBQSxRQUFRLENBQUMsVUFBRCxFQUFhLFlBQU07QUFDekIsVUFBSUssWUFBSjtBQUVBQyxNQUFBQSxVQUFVLENBQUMsWUFBTTtBQUNmRCxRQUFBQSxZQUFZLEdBQUcsSUFBSUYsMEJBQUosRUFBZjtBQUNELE9BRlMsQ0FBVjtBQUlBRixNQUFBQSxFQUFFLENBQUMsd0NBQUQsRUFBMkMs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QUFBLE1BQU0sQ0FBQ0csWUFBWSxDQUFDZ0IsTUFBZCxDQUFOLENBQTRCQyxPQUE1QixtQkFBeUNOLGFBQXpDLEVBQTJERSxjQUEzRDtBQUNELE9BSEMsQ0FBRjtBQUtBakIsTUFBQUEsRUFBRSxDQUFDLHNCQUFELEVBQXlCLFlBQU07QUFDL0JJLFFBQUFBLFlBQVksQ0FBQ2UsWUFBYixDQUEwQjtBQUFFSCxVQUFBQSxlQUFlLEVBQUU7QUFBbkIsU0FBMUI7QUFDQWYsUUFBQUEsTUFBTSxDQUFDRyxZQUFZLENBQUNnQixNQUFiLENBQW9CSixlQUFyQixDQUFOLENBQTRDTSxVQUE1QztBQUNELE9BSEMsQ0FBRjtBQUlELEtBbkJPLENBQVI7QUFvQkQsR0FsRk8sQ0FBUjtBQW1GRCxDQXBJTyxDQUFSIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTWVzc2FnZSB9IGZyb20gXCIuL21lc3NlbmdlclwiO1xuaW1wb3J0IHsgQWdlbnRTdGF0ZSwgTGF5b3V0U3RhdGUsIFN0YXRlTWFuYWdlciB9IGZyb20gXCIuL3N0YXRlLW1hbmFnZXJcIjtcblxuZGVzY3JpYmUoXCJTdGF0ZU1hbmFnZXJcIiwgKCkgPT4ge1xuICBkZXNjcmliZShcImxvY2FsU3RvcmFnZSB1bmF2YWlsYWJsZVwiLCAoKSA9PiB7XG4gICAgaXQoXCJub3QgdGhyb3cgYW55IGVycm9yIG9uIGNvbnN0cnVjdG9yXCIsICgpID0+IHtcbiAgICAgIGV4cGVjdChuZXcgU3RhdGVNYW5hZ2VyKCkpLnRvVGhyb3dFcnJvck1hdGNoaW5nU25hcHNob3QoKTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKFwibWVzc2FnZXNcIiwgKCkgPT4ge1xuICAgICAgbGV0IHN0YXRlTWFuYWdlcjogU3RhdGVNYW5hZ2VyO1xuXG4gICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgc3RhdGVNYW5hZ2VyID0gbmV3IFN0YXRlTWFuYWdlcigpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KFwiYWRkcyBuZXcgbWVzc2FnZSB3aGVuIG1lc3NhZ2UgaXMgc2F2ZWRcIiwgKCkgPT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlOiBNZXNzYWdlID0geyBzZW5kZXI6IFwiaHVtYW5cIiwgbGFiZWw6IFwidGVzdCBtZXNzYWdlXCIsIHR5cGU6IFwicGxhaW5cIiB9O1xuICAgICAgICBzdGF0ZU1hbmFnZXIuc2F2ZU1lc3NhZ2VzKFttZXNzYWdlXSk7XG5cbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5tZXNzYWdlc1swXSkudG9NYXRjaE9iamVjdChtZXNzYWdlKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcInJlbW92ZXMgbWVzc2FnZSB3aGVuIGl0IHBvcHNcIiwgKCkgPT4ge1xuICAgICAgICBzdGF0ZU1hbmFnZXIucG9wTWVzc2FnZSgpO1xuXG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIubWVzc2FnZXNbMF0pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoXCJsYXlvdXRcIiwgKCkgPT4ge1xuICAgICAgbGV0IHN0YXRlTWFuYWdlcjogU3RhdGVNYW5hZ2VyO1xuICAgICAgY29uc3QgaW5pdGlhbExheW91dDogTGF5b3V0U3RhdGUgPSB7IGlzTWVzc2VuZ2VyT3BlbjogZmFsc2UgfTtcbiAgICAgIGNvbnN0IG92ZXJyaWRlTGF5b3V0OiBMYXlvdXRTdGF0ZSA9IHsgc29tZVZhbHVlOiB0cnVlIH07XG5cbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBzdGF0ZU1hbmFnZXIgPSBuZXcgU3RhdGVNYW5hZ2VyKCk7XG4gICAgICAgIHN0YXRlTWFuYWdlci51cGRhdGVMYXlvdXQoaW5pdGlhbExheW91dCk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJhZGRzIGxheW91dCBwcm9wZXJ0aWVzXCIsICgpID0+IHtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnVwZGF0ZUxheW91dChvdmVycmlkZUxheW91dCk7XG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIubGF5b3V0KS50b0VxdWFsKHsgLi4uaW5pdGlhbExheW91dCwgLi4ub3ZlcnJpZGVMYXlvdXQgfSk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJvdmVycmlkZXMgYSBwcm9wZXJ0eVwiLCAoKSA9PiB7XG4gICAgICAgIHN0YXRlTWFuYWdlci51cGRhdGVMYXlvdXQoeyBpc01lc3Nlbmdlck9wZW46IHRydWUgfSk7XG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIubGF5b3V0LmlzTWVzc2VuZ2VyT3BlbikudG9CZVRydXRoeSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKFwibG9jYWxzdG9yYWdlIGF2YWlsYWJsZVwiLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICByZXF1aXJlKFwiamVzdC1sb2NhbHN0b3JhZ2UtbW9ja1wiKTtcbiAgICAgIGxvY2FsU3RvcmFnZS5jbGVhcigpO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoXCJ3aXRoIGNsZWFuIGxvY2FsU3RvcmFnZVwiLCAoKSA9PiB7XG4gICAgICBpdChcImluaXRpYWxpemVzIGVtcHR5IG1lc3NhZ2VzIHN0b3JhZ2VcIiwgKCkgPT4ge1xuICAgICAgICBleHBlY3QobmV3IFN0YXRlTWFuYWdlcigpLm1lc3NhZ2VzKS50b0hhdmVMZW5ndGgoMCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKFwiY29uc3RydWN0b3Igd2hlbiBleGlzdGluZyBsb2NhbFN0b3JhZ2VcIiwgKCkgPT4ge1xuICAgICAgbGV0IGluaXRpYWxNZXNzYWdlczogTWVzc2FnZVtdO1xuICAgICAgbGV0IGluaXRpYWxMYXlvdXQ6IExheW91dFN0YXRlO1xuICAgICAgbGV0IGluaXRpYWxBZ2VudDogQWdlbnRTdGF0ZTtcbiAgICAgIGxldCBzdGF0ZU1hbmFnZXI6IFN0YXRlTWFuYWdlcjtcblxuICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIGluaXRpYWxNZXNzYWdlcyA9IFt7IHR5cGU6IFwicGxhaW5cIiwgc2VuZGVyOiBcImJvdFwiLCBsYWJlbDogXCJUZXN0IG1lc3NhZ2UgZnJvbSBib3RcIiB9XTtcbiAgICAgICAgaW5pdGlhbExheW91dCA9IHsgaXNNZXNzZW5nZXJPcGVuOiB0cnVlIH07XG4gICAgICAgIGluaXRpYWxBZ2VudCA9IHsgaXNJbml0aWFsaXplZDogdHJ1ZSB9O1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShTdGF0ZU1hbmFnZXIua2V5cy5tZXNzYWdlcywgSlNPTi5zdHJpbmdpZnkoaW5pdGlhbE1lc3NhZ2VzKSk7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFN0YXRlTWFuYWdlci5rZXlzLmxheW91dCwgSlNPTi5zdHJpbmdpZnkoaW5pdGlhbExheW91dCkpO1xuICAgICAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShTdGF0ZU1hbmFnZXIua2V5cy5hZ2VudCwgSlNPTi5zdHJpbmdpZnkoaW5pdGlhbEFnZW50KSk7XG4gICAgICAgIHN0YXRlTWFuYWdlciA9IG5ldyBTdGF0ZU1hbmFnZXIoKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcImluaXRpYWxpemVzIG1lc3NhZ2VzIGZyb20gbG9jYWxTdG9yYWdlXCIsICgpID0+IHtcbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5tZXNzYWdlcykudG9FcXVhbChpbml0aWFsTWVzc2FnZXMpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KFwiaW5pdGlhbGl6ZXMgbGF5b3V0IGZyb20gbG9jYWxTdG9yYWdlXCIsICgpID0+IHtcbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5sYXlvdXQpLnRvRXF1YWwoaW5pdGlhbExheW91dCk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJpbml0aWFsaXplcyBhZ2VudCBmcm9tIGxvY2FsU3RvcmFnZVwiLCAoKSA9PiB7XG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIuYWdlbnQpLnRvRXF1YWwoaW5pdGlhbEFnZW50KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoXCJtZXNzYWdlc1wiLCAoKSA9PiB7XG4gICAgICBsZXQgc3RhdGVNYW5hZ2VyOiBTdGF0ZU1hbmFnZXI7XG5cbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBzdGF0ZU1hbmFnZXIgPSBuZXcgU3RhdGVNYW5hZ2VyKCk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJhZGRzIG5ldyBtZXNzYWdlIHdoZW4gbWVzc2FnZSBpcyBzYXZlZFwiLCAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1lc3NhZ2U6IE1lc3NhZ2UgPSB7IHNlbmRlcjogXCJodW1hblwiLCBsYWJlbDogXCJ0ZXN0IG1lc3NhZ2VcIiwgdHlwZTogXCJwbGFpblwiIH07XG4gICAgICAgIHN0YXRlTWFuYWdlci5zYXZlTWVzc2FnZXMoW21lc3NhZ2VdKTtcblxuICAgICAgICBleHBlY3Qoc3RhdGVNYW5hZ2VyLm1lc3NhZ2VzWzBdKS50b01hdGNoT2JqZWN0KG1lc3NhZ2UpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KFwicmVtb3ZlcyBtZXNzYWdlIHdoZW4gaXQgcG9wc1wiLCAoKSA9PiB7XG4gICAgICAgIHN0YXRlTWFuYWdlci5wb3BNZXNzYWdlKCk7XG5cbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5tZXNzYWdlc1swXSkudG9CZVVuZGVmaW5lZCgpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZShcImxheW91dFwiLCAoKSA9PiB7XG4gICAgICBsZXQgc3RhdGVNYW5hZ2VyOiBTdGF0ZU1hbmFnZXI7XG4gICAgICBjb25zdCBpbml0aWFsTGF5b3V0OiBMYXlvdXRTdGF0ZSA9IHsgaXNNZXNzZW5nZXJPcGVuOiBmYWxzZSB9O1xuICAgICAgY29uc3Qgb3ZlcnJpZGVMYXlvdXQ6IExheW91dFN0YXRlID0geyBzb21lVmFsdWU6IHRydWUgfTtcblxuICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIHN0YXRlTWFuYWdlciA9IG5ldyBTdGF0ZU1hbmFnZXIoKTtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnVwZGF0ZUxheW91dChpbml0aWFsTGF5b3V0KTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcImFkZHMgbGF5b3V0IHByb3BlcnRpZXNcIiwgKCkgPT4ge1xuICAgICAgICBzdGF0ZU1hbmFnZXIudXBkYXRlTGF5b3V0KG92ZXJyaWRlTGF5b3V0KTtcbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5sYXlvdXQpLnRvRXF1YWwoeyAuLi5pbml0aWFsTGF5b3V0LCAuLi5vdmVycmlkZUxheW91dCB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcIm92ZXJyaWRlcyBhIHByb3BlcnR5XCIsICgpID0+IHtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnVwZGF0ZUxheW91dCh7IGlzTWVzc2VuZ2VyT3BlbjogdHJ1ZSB9KTtcbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5sYXlvdXQuaXNNZXNzZW5nZXJPcGVuKS50b0JlVHJ1dGh5KCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG59KTtcbiJdfQ==