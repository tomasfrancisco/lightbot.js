"use strict";

var _stateManager = require("./state-manager");

function _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; var ownKeys = Object.keys(source); if (typeof Object.getOwnPropertySymbols === 'function') { ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) { return Object.getOwnPropertyDescriptor(source, sym).enumerable; })); } ownKeys.forEach(function (key) { _defineProperty(target, key, source[key]); }); } return target; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

describe("StateManager", function () {
  describe("localStorage unavailable", function () {
    beforeEach(function () {});
    it("not throw any error on constructor", function () {
      expect(new _stateManager.StateManager()).toThrowErrorMatchingSnapshot();
    });
    describe("messages", function () {
      var stateManager;
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
      });
      it("adds new message when message is saved", function () {
        var message = {
          sender: "human",
          label: "test message",
          type: "plain"
        };
        stateManager.saveMessages([message]);
        expect(stateManager.messages[0]).toMatchObject(message);
      });
      it("removes message when it pops", function () {
        stateManager.popMessage();
        expect(stateManager.messages[0]).toBeUndefined();
      });
    });
    describe("layout", function () {
      var stateManager;
      var initialLayout = {
        isMessengerOpen: false
      };
      var overrideLayout = {
        someValue: true
      };
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
        stateManager.updateLayout(initialLayout);
      });
      it("adds layout properties", function () {
        stateManager.updateLayout(overrideLayout);
        expect(stateManager.layout).toEqual(_objectSpread({}, initialLayout, overrideLayout));
      });
      it("overrides a property", function () {
        stateManager.updateLayout({
          isMessengerOpen: true
        });
        expect(stateManager.layout.isMessengerOpen).toBeTruthy();
      });
    });
  });
  describe("localstorage available", function () {
    beforeEach(function () {
      require("jest-localstorage-mock");

      localStorage.clear();
    });
    describe("with clean localStorage", function () {
      it("initializes empty messages storage", function () {
        expect(new _stateManager.StateManager().messages).toHaveLength(0);
      });
    });
    describe("constructor when existing localStorage", function () {
      var initialMessages;
      var initialLayout;
      var initialAgent;
      var stateManager;
      beforeEach(function () {
        initialMessages = [{
          type: "plain",
          sender: "bot",
          label: "Test message from bot"
        }];
        initialLayout = {
          isMessengerOpen: true
        };
        initialAgent = {
          isInitialized: true
        };
        localStorage.setItem(_stateManager.StateManager.keys.messages, JSON.stringify(initialMessages));
        localStorage.setItem(_stateManager.StateManager.keys.layout, JSON.stringify(initialLayout));
        localStorage.setItem(_stateManager.StateManager.keys.agent, JSON.stringify(initialAgent));
        stateManager = new _stateManager.StateManager();
      });
      it("initializes messages from localStorage", function () {
        expect(stateManager.messages).toEqual(initialMessages);
      });
      it("initializes layout from localStorage", function () {
        expect(stateManager.layout).toEqual(initialLayout);
      });
      it("initializes agent from localStorage", function () {
        expect(stateManager.agent).toEqual(initialAgent);
      });
    });
    describe("messages", function () {
      var stateManager;
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
      });
      it("adds new message when message is saved", function () {
        var message = {
          sender: "human",
          label: "test message",
          type: "plain"
        };
        stateManager.saveMessages([message]);
        expect(stateManager.messages[0]).toMatchObject(message);
      });
      it("removes message when it pops", function () {
        stateManager.popMessage();
        expect(stateManager.messages[0]).toBeUndefined();
      });
    });
    describe("layout", function () {
      var stateManager;
      var initialLayout = {
        isMessengerOpen: false
      };
      var overrideLayout = {
        someValue: true
      };
      beforeEach(function () {
        stateManager = new _stateManager.StateManager();
        stateManager.updateLayout(initialLayout);
      });
      it("adds layout properties", function () {
        stateManager.updateLayout(overrideLayout);
        expect(stateManager.layout).toEqual(_objectSpread({}, initialLayout, overrideLayout));
      });
      it("overrides a property", function () {
        stateManager.updateLayout({
          isMessengerOpen: true
        });
        expect(stateManager.layout.isMessengerOpen).toBeTruthy();
      });
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9zdGF0ZS1tYW5hZ2VyLnNwZWMudHMiXSwibmFtZXMiOlsiZGVzY3JpYmUiLCJiZWZvcmVFYWNoIiwiaXQiLCJleHBlY3QiLCJTdGF0ZU1hbmFnZXIiLCJ0b1Rocm93RXJyb3JNYXRjaGluZ1NuYXBzaG90Iiwic3RhdGVNYW5hZ2VyIiwibWVzc2FnZSIsInNlbmRlciIsImxhYmVsIiwidHlwZSIsInNhdmVNZXNzYWdlcyIsIm1lc3NhZ2VzIiwidG9NYXRjaE9iamVjdCIsInBvcE1lc3NhZ2UiLCJ0b0JlVW5kZWZpbmVkIiwiaW5pdGlhbExheW91dCIsImlzTWVzc2VuZ2VyT3BlbiIsIm92ZXJyaWRlTGF5b3V0Iiwic29tZVZhbHVlIiwidXBkYXRlTGF5b3V0IiwibGF5b3V0IiwidG9FcXVhbCIsInRvQmVUcnV0aHkiLCJyZXF1aXJlIiwibG9jYWxTdG9yYWdlIiwiY2xlYXIiLCJ0b0hhdmVMZW5ndGgiLCJpbml0aWFsTWVzc2FnZXMiLCJpbml0aWFsQWdlbnQiLCJpc0luaXRpYWxpemVkIiwic2V0SXRlbSIsImtleXMiLCJKU09OIiwic3RyaW5naWZ5IiwiYWdlbnQiXSwibWFwcGluZ3MiOiI7O0FBQUE7Ozs7OztBQUdBQSxRQUFRLENBQUMsY0FBRCxFQUFpQixZQUFNO0FBQzdCQSxFQUFBQSxRQUFRLENBQUMsMEJBQUQsRUFBNkIsWUFBTTtBQUN6Q0MsSUFBQUEsVUFBVSxDQUFDLFlBQU0sQ0FBRSxDQUFULENBQVY7QUFFQUMsSUFBQUEsRUFBRSxDQUFDLG9DQUFELEVBQXVDLFlBQU07QUFDN0NDLE1BQUFBLE1BQU0sQ0FBQyxJQUFJQywwQkFBSixFQUFELENBQU4sQ0FBMkJDLDRCQUEzQjtBQUNELEtBRkMsQ0FBRjtBQUlBTCxJQUFBQSxRQUFRLENBQUMsVUFBRCxFQUFhLFlBQU07QUFDekIsVUFBSU0sWUFBSjtBQUVBTCxNQUFBQSxVQUFVLENBQUMsWUFBTTtBQUNmSyxRQUFBQSxZQUFZLEdBQUcsSUFBSUYsMEJBQUosRUFBZjtBQUNELE9B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QSxZQUFZLENBQUNjLFlBQWIsQ0FBMEJGLGNBQTFCO0FBQ0FmLFFBQUFBLE1BQU0sQ0FBQ0csWUFBWSxDQUFDZSxNQUFkLENBQU4sQ0FBNEJDLE9BQTVCLG1CQUF5Q04sYUFBekMsRUFBMkRFLGNBQTNEO0FBQ0QsT0FIQyxDQUFGO0FBS0FoQixNQUFBQSxFQUFFLENBQUMsc0JBQUQsRUFBeUIsWUFBTTtBQUMvQkksUUFBQUEsWUFBWSxDQUFDYyxZQUFiLENBQTBCO0FBQUVILFVBQUFBLGVBQWUsRUFBRTtBQUFuQixTQUExQjtBQUNBZCxRQUFBQSxNQUFNLENBQUNHLFlBQVksQ0FBQ2UsTUFBYixDQUFvQkosZUFBckIsQ0FBTixDQUE0Q00sVUFBNUM7QUFDRCxPQUhDLENBQUY7QUFJRCxLQW5CTyxDQUFSO0FBb0JELEdBbEZPLENBQVI7QUFtRkQsQ0F0SU8sQ0FBUiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFN0YXRlTWFuYWdlciwgTGF5b3V0U3RhdGUsIEFnZW50U3RhdGUgfSBmcm9tIFwiLi9zdGF0ZS1tYW5hZ2VyXCI7XG5pbXBvcnQgeyBNZXNzYWdlIH0gZnJvbSBcIi4vbWVzc2VuZ2VyXCI7XG5cbmRlc2NyaWJlKFwiU3RhdGVNYW5hZ2VyXCIsICgpID0+IHtcbiAgZGVzY3JpYmUoXCJsb2NhbFN0b3JhZ2UgdW5hdmFpbGFibGVcIiwgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge30pO1xuXG4gICAgaXQoXCJub3QgdGhyb3cgYW55IGVycm9yIG9uIGNvbnN0cnVjdG9yXCIsICgpID0+IHtcbiAgICAgIGV4cGVjdChuZXcgU3RhdGVNYW5hZ2VyKCkpLnRvVGhyb3dFcnJvck1hdGNoaW5nU25hcHNob3QoKTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKFwibWVzc2FnZXNcIiwgKCkgPT4ge1xuICAgICAgbGV0IHN0YXRlTWFuYWdlcjogU3RhdGVNYW5hZ2VyO1xuXG4gICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgc3RhdGVNYW5hZ2VyID0gbmV3IFN0YXRlTWFuYWdlcigpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KFwiYWRkcyBuZXcgbWVzc2FnZSB3aGVuIG1lc3NhZ2UgaXMgc2F2ZWRcIiwgKCkgPT4ge1xuICAgICAgICBjb25zdCBtZXNzYWdlOiBNZXNzYWdlID0geyBzZW5kZXI6IFwiaHVtYW5cIiwgbGFiZWw6IFwidGVzdCBtZXNzYWdlXCIsIHR5cGU6IFwicGxhaW5cIiB9O1xuICAgICAgICBzdGF0ZU1hbmFnZXIuc2F2ZU1lc3NhZ2VzKFttZXNzYWdlXSk7XG5cbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5tZXNzYWdlc1swXSkudG9NYXRjaE9iamVjdChtZXNzYWdlKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcInJlbW92ZXMgbWVzc2FnZSB3aGVuIGl0IHBvcHNcIiwgKCkgPT4ge1xuICAgICAgICBzdGF0ZU1hbmFnZXIucG9wTWVzc2FnZSgpO1xuXG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIubWVzc2FnZXNbMF0pLnRvQmVVbmRlZmluZWQoKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoXCJsYXlvdXRcIiwgKCkgPT4ge1xuICAgICAgbGV0IHN0YXRlTWFuYWdlcjogU3RhdGVNYW5hZ2VyO1xuICAgICAgbGV0IGluaXRpYWxMYXlvdXQ6IExheW91dFN0YXRlID0geyBpc01lc3Nlbmdlck9wZW46IGZhbHNlIH07XG4gICAgICBsZXQgb3ZlcnJpZGVMYXlvdXQ6IExheW91dFN0YXRlID0geyBzb21lVmFsdWU6IHRydWUgfTtcblxuICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIHN0YXRlTWFuYWdlciA9IG5ldyBTdGF0ZU1hbmFnZXIoKTtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnVwZGF0ZUxheW91dChpbml0aWFsTGF5b3V0KTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcImFkZHMgbGF5b3V0IHByb3BlcnRpZXNcIiwgKCkgPT4ge1xuICAgICAgICBzdGF0ZU1hbmFnZXIudXBkYXRlTGF5b3V0KG92ZXJyaWRlTGF5b3V0KTtcbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5sYXlvdXQpLnRvRXF1YWwoeyAuLi5pbml0aWFsTGF5b3V0LCAuLi5vdmVycmlkZUxheW91dCB9KTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcIm92ZXJyaWRlcyBhIHByb3BlcnR5XCIsICgpID0+IHtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnVwZGF0ZUxheW91dCh7IGlzTWVzc2VuZ2VyT3BlbjogdHJ1ZSB9KTtcbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5sYXlvdXQuaXNNZXNzZW5nZXJPcGVuKS50b0JlVHJ1dGh5KCk7XG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoXCJsb2NhbHN0b3JhZ2UgYXZhaWxhYmxlXCIsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIHJlcXVpcmUoXCJqZXN0LWxvY2Fsc3RvcmFnZS1tb2NrXCIpO1xuICAgICAgbG9jYWxTdG9yYWdlLmNsZWFyKCk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZShcIndpdGggY2xlYW4gbG9jYWxTdG9yYWdlXCIsICgpID0+IHtcbiAgICAgIGl0KFwiaW5pdGlhbGl6ZXMgZW1wdHkgbWVzc2FnZXMgc3RvcmFnZVwiLCAoKSA9PiB7XG4gICAgICAgIGV4cGVjdChuZXcgU3RhdGVNYW5hZ2VyKCkubWVzc2FnZXMpLnRvSGF2ZUxlbmd0aCgwKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuXG4gICAgZGVzY3JpYmUoXCJjb25zdHJ1Y3RvciB3aGVuIGV4aXN0aW5nIGxvY2FsU3RvcmFnZVwiLCAoKSA9PiB7XG4gICAgICBsZXQgaW5pdGlhbE1lc3NhZ2VzOiBNZXNzYWdlW107XG4gICAgICBsZXQgaW5pdGlhbExheW91dDogTGF5b3V0U3RhdGU7XG4gICAgICBsZXQgaW5pdGlhbEFnZW50OiBBZ2VudFN0YXRlO1xuICAgICAgbGV0IHN0YXRlTWFuYWdlcjogU3RhdGVNYW5hZ2VyO1xuXG4gICAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgICAgaW5pdGlhbE1lc3NhZ2VzID0gW3sgdHlwZTogXCJwbGFpblwiLCBzZW5kZXI6IFwiYm90XCIsIGxhYmVsOiBcIlRlc3QgbWVzc2FnZSBmcm9tIGJvdFwiIH1dO1xuICAgICAgICBpbml0aWFsTGF5b3V0ID0geyBpc01lc3Nlbmdlck9wZW46IHRydWUgfTtcbiAgICAgICAgaW5pdGlhbEFnZW50ID0geyBpc0luaXRpYWxpemVkOiB0cnVlIH07XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFN0YXRlTWFuYWdlci5rZXlzLm1lc3NhZ2VzLCBKU09OLnN0cmluZ2lmeShpbml0aWFsTWVzc2FnZXMpKTtcbiAgICAgICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oU3RhdGVNYW5hZ2VyLmtleXMubGF5b3V0LCBKU09OLnN0cmluZ2lmeShpbml0aWFsTGF5b3V0KSk7XG4gICAgICAgIGxvY2FsU3RvcmFnZS5zZXRJdGVtKFN0YXRlTWFuYWdlci5rZXlzLmFnZW50LCBKU09OLnN0cmluZ2lmeShpbml0aWFsQWdlbnQpKTtcbiAgICAgICAgc3RhdGVNYW5hZ2VyID0gbmV3IFN0YXRlTWFuYWdlcigpO1xuICAgICAgfSk7XG5cbiAgICAgIGl0KFwiaW5pdGlhbGl6ZXMgbWVzc2FnZXMgZnJvbSBsb2NhbFN0b3JhZ2VcIiwgKCkgPT4ge1xuICAgICAgICBleHBlY3Qoc3RhdGVNYW5hZ2VyLm1lc3NhZ2VzKS50b0VxdWFsKGluaXRpYWxNZXNzYWdlcyk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJpbml0aWFsaXplcyBsYXlvdXQgZnJvbSBsb2NhbFN0b3JhZ2VcIiwgKCkgPT4ge1xuICAgICAgICBleHBlY3Qoc3RhdGVNYW5hZ2VyLmxheW91dCkudG9FcXVhbChpbml0aWFsTGF5b3V0KTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcImluaXRpYWxpemVzIGFnZW50IGZyb20gbG9jYWxTdG9yYWdlXCIsICgpID0+IHtcbiAgICAgICAgZXhwZWN0KHN0YXRlTWFuYWdlci5hZ2VudCkudG9FcXVhbChpbml0aWFsQWdlbnQpO1xuICAgICAgfSk7XG4gICAgfSk7XG5cbiAgICBkZXNjcmliZShcIm1lc3NhZ2VzXCIsICgpID0+IHtcbiAgICAgIGxldCBzdGF0ZU1hbmFnZXI6IFN0YXRlTWFuYWdlcjtcblxuICAgICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICAgIHN0YXRlTWFuYWdlciA9IG5ldyBTdGF0ZU1hbmFnZXIoKTtcbiAgICAgIH0pO1xuXG4gICAgICBpdChcImFkZHMgbmV3IG1lc3NhZ2Ugd2hlbiBtZXNzYWdlIGlzIHNhdmVkXCIsICgpID0+IHtcbiAgICAgICAgY29uc3QgbWVzc2FnZTogTWVzc2FnZSA9IHsgc2VuZGVyOiBcImh1bWFuXCIsIGxhYmVsOiBcInRlc3QgbWVzc2FnZVwiLCB0eXBlOiBcInBsYWluXCIgfTtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnNhdmVNZXNzYWdlcyhbbWVzc2FnZV0pO1xuXG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIubWVzc2FnZXNbMF0pLnRvTWF0Y2hPYmplY3QobWVzc2FnZSk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJyZW1vdmVzIG1lc3NhZ2Ugd2hlbiBpdCBwb3BzXCIsICgpID0+IHtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnBvcE1lc3NhZ2UoKTtcblxuICAgICAgICBleHBlY3Qoc3RhdGVNYW5hZ2VyLm1lc3NhZ2VzWzBdKS50b0JlVW5kZWZpbmVkKCk7XG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGRlc2NyaWJlKFwibGF5b3V0XCIsICgpID0+IHtcbiAgICAgIGxldCBzdGF0ZU1hbmFnZXI6IFN0YXRlTWFuYWdlcjtcbiAgICAgIGxldCBpbml0aWFsTGF5b3V0OiBMYXlvdXRTdGF0ZSA9IHsgaXNNZXNzZW5nZXJPcGVuOiBmYWxzZSB9O1xuICAgICAgbGV0IG92ZXJyaWRlTGF5b3V0OiBMYXlvdXRTdGF0ZSA9IHsgc29tZVZhbHVlOiB0cnVlIH07XG5cbiAgICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgICBzdGF0ZU1hbmFnZXIgPSBuZXcgU3RhdGVNYW5hZ2VyKCk7XG4gICAgICAgIHN0YXRlTWFuYWdlci51cGRhdGVMYXlvdXQoaW5pdGlhbExheW91dCk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJhZGRzIGxheW91dCBwcm9wZXJ0aWVzXCIsICgpID0+IHtcbiAgICAgICAgc3RhdGVNYW5hZ2VyLnVwZGF0ZUxheW91dChvdmVycmlkZUxheW91dCk7XG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIubGF5b3V0KS50b0VxdWFsKHsgLi4uaW5pdGlhbExheW91dCwgLi4ub3ZlcnJpZGVMYXlvdXQgfSk7XG4gICAgICB9KTtcblxuICAgICAgaXQoXCJvdmVycmlkZXMgYSBwcm9wZXJ0eVwiLCAoKSA9PiB7XG4gICAgICAgIHN0YXRlTWFuYWdlci51cGRhdGVMYXlvdXQoeyBpc01lc3Nlbmdlck9wZW46IHRydWUgfSk7XG4gICAgICAgIGV4cGVjdChzdGF0ZU1hbmFnZXIubGF5b3V0LmlzTWVzc2VuZ2VyT3BlbikudG9CZVRydXRoeSgpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG4iXX0=